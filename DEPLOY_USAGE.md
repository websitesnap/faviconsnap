# 🚀 FaviconSnap 智能部署脚本使用说明

## 📋 概述

`deploy.sh` 是一个智能化部署脚本，能够自动检测项目状态，智能决定是初始化配置还是直接部署，为 FaviconSnap 项目提供一站式部署解决方案。

## 🎯 核心特性

### 🧠 智能检测
- **配置状态检测**: 自动检查 `wrangler.toml` 是否存在和配置是否完整
- **KV 存储检测**: 验证 KV 命名空间配置状态
- **占位符检测**: 识别配置文件中的占位符内容
- **决策逻辑**: 根据检测结果自动决定执行初始化还是部署

### 🔧 自动配置
- **KV 存储创建**: 自动创建和配置 KV 命名空间
- **配置文件生成**: 智能生成 `wrangler.toml` 配置文件
- **项目名称推导**: 基于目录名自动生成合适的项目名称
- **备份保护**: 自动备份现有配置文件

### ✅ 全面检查
- **环境验证**: 检查 wrangler、curl、jq 等必要工具
- **登录状态**: 验证 Cloudflare 账户登录状态
- **语法检查**: JavaScript 代码语法验证
- **配置验证**: 确保所有配置项正确设置

### 🚀 智能部署
- **多模式支持**: 智能模式、强制配置、仅部署等多种模式
- **实时反馈**: 彩色输出和详细进度提示
- **错误处理**: 智能错误诊断和解决建议
- **部署测试**: 自动测试主页、API、中文页面功能
- **详细报告**: 完整的部署信息和访问地址展示

## 📖 使用方法

### 智能模式（推荐）

```bash
# 智能检测并自动执行相应操作
./deploy.sh
```

### 高级选项

```bash
# 强制重新配置所有设置
./deploy.sh --setup

# 仅部署，跳过配置检查
./deploy.sh --deploy-only

# 跳过部署后测试（加快部署速度）
./deploy.sh --skip-tests

# 显示帮助信息
./deploy.sh --help
```

### 使用流程

1. **运行脚本**
   ```bash
   ./deploy.sh
   ```

2. **自动检查**
   - 脚本会自动执行所有必要的检查
   - 如有问题会显示具体的解决方案

3. **确认部署**
   - 检查通过后，脚本会询问是否继续部署
   - 输入 `y` 确认，`n` 取消

4. **部署完成**
   - 自动执行部署并显示结果
   - 提供访问链接和管理命令

## 🔧 常见问题解决

### 问题1: wrangler 未安装
```bash
npm install -g wrangler
```

### 问题2: 未登录 Cloudflare
```bash
wrangler login
```

### 问题3: 缺少 wrangler.toml
```bash
cp wrangler.toml.example wrangler.toml
# 然后编辑 wrangler.toml 中的配置项
```

### 问题4: 需要创建 KV 存储
```bash
wrangler kv namespace create "FAVICON_CACHE"
# 将返回的 ID 更新到 wrangler.toml 中
```

## 📂 输出示例

```
==================================================
🚀 FaviconSnap 快速部署工具
==================================================

ℹ️  检查部署环境...
✅ 环境检查通过
ℹ️  检查 Cloudflare 登录状态...
✅ 已登录: your@email.com
ℹ️  检查配置文件...
✅ 配置文件检查通过
ℹ️  检查 KV 存储...
✅ KV 存储检查通过
ℹ️  执行预部署检查...
✅ 代码语法检查通过

⚠️  即将开始部署，是否继续？(y/N)
y
ℹ️  开始部署到 Cloudflare Workers...
✅ 部署成功！耗时: 4秒

ℹ️  执行部署后测试...
✅ 主页测试通过
✅ 中文页面测试通过
✅ API 测试通过

📊 部署信息:
版本ID: f0e8a326-41cc-4297-8ca9-5e75c829a5d4
创建时间: 2025-08-03T04:24:00.000Z

🌐 访问地址:
  英文版: https://faviconsnap.com/
  中文版: https://faviconsnap.com/zh

🎉 FaviconSnap 部署完成！
```

## 🛠️ 部署后管理

### 查看实时日志
```bash
wrangler tail
```

### 查看部署历史
```bash
wrangler deployments list
```

### 回滚到指定版本
```bash
wrangler rollback [version-id]
```

## 🔒 安全说明

- ✅ 脚本已加入 `.gitignore`，不会被提交到仓库
- ✅ 不包含任何敏感信息
- ✅ 所有配置都从 `wrangler.toml` 读取
- ✅ 支持环境特定的配置

## 📝 注意事项

1. **运行环境**: 确保在项目根目录下运行脚本
2. **网络连接**: 需要稳定的网络连接访问 Cloudflare API
3. **权限配置**: 确保 Cloudflare Token 有足够的权限
4. **域名配置**: 如果使用自定义域名，确保 DNS 已正确配置

---

💡 **提示**: 首次使用建议先阅读 `README_ZH.md` 中的详细配置说明。